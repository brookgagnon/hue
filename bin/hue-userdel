#!/usr/bin/php
<?php

namespace hue\commands;

function userdel()
{

  $driver = new \mysqli_driver();
  $driver->report_mode = MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT;

  $db = new \mysqli('localhost','root');

  // ask for username and validate
  $username = readline('Username: ');

  // see if user exists
  if(!\hue\user_get($username))
  {
    echo 'User doesn\'t seem to exist.'.PHP_EOL;
    return false;
  }

  echo PHP_EOL.'This will delete the system user, database user, home directory, and databases (TODO).'.PHP_EOL.'Are you sure you want to do this?'.PHP_EOL.PHP_EOL;
  $confirm = readline('Type the username again to confirm: ');
  if($confirm!=$username)
  {
    echo 'Username does not match. Please try again.'.PHP_EOL;
    return false;
  }

  try
  {
    // remove sql user
    $db->query("DROP USER `$username`@localhost");

    // remove system user
    $result_code = null;
    passthru("userdel -r $username", $result_code);
    if($result_code!==0) throw new Exception('Error removing account with userdel command.');

    // remove user record
    unlink("/etc/hue/$username");
  }
  catch (Exception | mysqli_sql_exception $e)
  {
    echo $e.PHP_EOL;
    return false;
  }

  echo PHP_EOL.'User "'.$username.'" deleted.'.PHP_EOL;
  return true;
}
